import asyncio
from telethon import TelegramClient, events
from telethon.sessions import StringSession
from telethon.errors import PhoneNumberInvalidError, PhoneCodeInvalidError, SessionPasswordNeededError
from telegram.ext import Application, CommandHandler, ContextTypes

import os

# === –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ===
API_ID = int(os.environ.get("API_ID"))
API_HASH = os.environ.get("API_HASH"))
BOT_TOKEN = os.environ.get("BOT_TOKEN"))

# –•—Ä–∞–Ω–∏–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤ –ø–∞–º—è—Ç–∏, –Ω–µ –≤ –ë–î)
user_sessions = {}
user_keywords = {}


# === –®–∞–≥ 1. /connect ===
async def connect(update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ +79991234567:")
    context.user_data["awaiting_phone"] = True


# === –®–∞–≥ 2. –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ ===
async def handle_message(update, context):
    user_id = update.effective_user.id
    text = update.message.text.strip()

    # –ï—Å–ª–∏ –∂–¥–µ–º –Ω–æ–º–µ—Ä
    if context.user_data.get("awaiting_phone"):
        phone = text
        try:
            session = StringSession()
            client = TelegramClient(session, API_ID, API_HASH)
            await client.connect()
            await client.send_code_request(phone)
            user_sessions[user_id] = {"client": client, "session": session, "phone": phone}
            context.user_data["awaiting_phone"] = False
            context.user_data["awaiting_code"] = True
            await update.message.reply_text("–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥, –ø—Ä–∏—à–µ–¥—à–∏–π –≤ Telegram:")
        except PhoneNumberInvalidError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return

    # –ï—Å–ª–∏ –∂–¥–µ–º –∫–æ–¥
    if context.user_data.get("awaiting_code"):
        code = text
        data = user_sessions.get(user_id)
        client = data["client"]
        phone = data["phone"]
        try:
            await client.sign_in(phone=phone, code=code)
            context.user_data["awaiting_code"] = False
            await update.message.reply_text("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!\n–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:")
            context.user_data["awaiting_keywords"] = True
        except PhoneCodeInvalidError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥.")
        except SessionPasswordNeededError:
            await update.message.reply_text("–£ –≤–∞—Å –≤–∫–ª—é—á–µ–Ω–∞ –¥–≤—É—Ö—ç—Ç–∞–ø–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è. –≠—Ç–æ—Ç –±–æ—Ç –µ—ë –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç.")
        return

    # –ï—Å–ª–∏ –∂–¥–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
    if context.user_data.get("awaiting_keywords"):
        kws = [w.strip().lower() for w in text.split(",")]
        user_keywords[user_id] = kws
        context.user_data["awaiting_keywords"] = False
        await update.message.reply_text(f"üîç –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: {', '.join(kws)}\n–ë–æ—Ç —Ç–µ–ø–µ—Ä—å —á–∏—Ç–∞–µ—Ç –≤–∞—à–∏ —á–∞—Ç—ã.")
        asyncio.create_task(start_monitoring(user_id))
        return


# === –®–∞–≥ 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ===
async def start_monitoring(user_id):
    data = user_sessions[user_id]
    client = data["client"]
    keywords = user_keywords.get(user_id, [])

    @client.on(events.NewMessage(incoming=True))
    async def handler(event):
        text = event.message.message.lower()
        if any(k in text for k in keywords):
            chat = await event.get_chat()
            await client.send_message("me", f"üõ∞ –ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ:\n–ß–∞—Ç: {chat.title or chat.username}\n\n{text}")

    await client.run_until_disconnected()


# === –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ ===
async def main():
    app = Application.builder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start", connect))
    app.add_handler(CommandHandler("help", connect))
    app.add_handler(CommandHandler("monitor", connect))
    app.add_handler(CommandHandler("connect", connect))
    app.add_handler(CommandHandler("start